<!doctype html>
<html lang="fa" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ù… - Ù†Ø³Ø®Ù‡ Ø§Ø´ØªØ±Ø§Ú©ÛŒ</title>
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.6/dist/jalaali.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Vazir', 'Tahoma', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .login-container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .login-header h1 {
      margin: 0 0 10px 0;
      color: #667eea;
      font-size: 28px;
    }
    
    .login-header p {
      margin: 0 0 30px 0;
      color: #666;
      font-size: 16px;
    }
    
    .login-error {
      background: #fee;
      color: #e74c3c;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #e74c3c;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      text-align: center;
      position: relative;
    }
    
    .header h1 {
      margin: 0 0 10px 0;
      color: #667eea;
      font-size: 32px;
    }
    
    .header-actions {
      position: absolute;
      top: 25px;
      left: 25px;
      display: flex;
      gap: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #666;
      font-size: 14px;
      font-weight: normal;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-card.overdue .value {
      color: #e74c3c;
    }
    
    .stat-card.upcoming .value {
      color: #f39c12;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-secondary {
      background: #95a5a6;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #7f8c8d;
    }
    
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c0392b;
    }
    
    .btn-success {
      background: #27ae60;
      color: white;
    }
    
    .btn-success:hover {
      background: #229954;
    }
    
    .btn-warning {
      background: #f39c12;
      color: white;
    }
    
    .btn-warning:hover {
      background: #e67e22;
    }
    
    .loans-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .section-header h2 {
      margin: 0;
      color: #333;
    }
    
    .loan-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-right: 5px solid #667eea;
      transition: all 0.3s;
    }
    
    .loan-card:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .loan-card.overdue {
      border-right-color: #e74c3c;
      background: #fee;
    }
    
    .loan-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .loan-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    
    .loan-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 3px;
    }
    
    .info-value {
      font-size: 14px;
      color: #333;
      font-weight: bold;
    }
    
    .loan-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .loan-actions button {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: #27ae60;
      transition: width 0.3s;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      margin: 0;
      color: #333;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    
    .installments-grid {
      display: grid;
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .installment-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-right: 4px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .installment-item:hover {
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .installment-item.paid {
      border-right-color: #27ae60;
      background: #e8f5e9;
    }
    
    .paid-checkmark {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #27ae60;
      color: white;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .installment-item.overdue {
      border-right-color: #e74c3c;
      background: #fee;
    }
    
    .installment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .installment-number {
      font-weight: bold;
      color: #667eea;
    }
    
    .installment-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .installment-status.paid {
      background: #27ae60;
      color: white;
    }
    
    .installment-status.pending {
      background: #f39c12;
      color: white;
    }
    
    .installment-status.overdue {
      background: #e74c3c;
      color: white;
    }
    
    .installment-info {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }
    
    .calendar {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .calendar-header button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .calendar-header button:hover {
      background: #5568d3;
    }
    
    .calendar-title {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.3s;
    }
    
    .calendar-title:hover {
      background: #f0f0f0;
    }
    
    .year-month-selector {
      display: none;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .year-month-selector.active {
      display: flex;
    }
    
    .year-month-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .year-month-row select {
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    
    .calendar-day {
      padding: 10px;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .calendar-day:hover {
      background: #f0f0f0;
    }
    
    .calendar-day.selected {
      background: #667eea;
      color: white;
    }
    
    .calendar-day.disabled {
      color: #ccc;
      cursor: not-allowed;
    }
    
    .calendar-day.disabled:hover {
      background: transparent;
    }
    
    .calendar-weekday {
      font-weight: bold;
      color: #667eea;
      padding: 10px;
      text-align: center;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #333;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 2000;
      animation: slideIn 0.3s;
      max-width: 400px;
    }
    
    .toast.success {
      background: #27ae60;
    }
    
    .toast.error {
      background: #e74c3c;
    }
    
    .toast.warning {
      background: #f39c12;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .confirm-dialog {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 400px;
      text-align: center;
    }
    
    .confirm-dialog h3 {
      margin: 0 0 15px 0;
      color: #e74c3c;
    }
    
    .confirm-dialog p {
      margin: 0 0 20px 0;
      color: #666;
    }
    
    .confirm-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #666;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .tab:hover {
      color: #667eea;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .guarantor-item {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .guarantor-input {
      flex: 1;
    }
    
    .developer-credit {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 16px;
      border-radius: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #333;
      z-index: 1000;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .developer-credit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .telegram-icon {
      width: 24px;
      height: 24px;
      background: #0088cc;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .telegram-icon:hover {
      background: #006699;
      transform: scale(1.1);
    }
    
    .sync-status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      font-size: 12px;
      color: #666;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }
    
    .sync-status.syncing {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }
    
    .data-info {
      background: #e8f4fd;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #0066cc;
    }
    
    .data-info strong {
      color: #004499;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .header-actions {
        position: static;
        margin-top: 15px;
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .loan-info {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        padding: 20px;
      }
      
      .toast {
        right: 10px;
        left: 10px;
        bottom: 10px;
      }
      
      .developer-credit {
        bottom: 10px;
        left: 10px;
        font-size: 12px;
        padding: 8px 12px;
      }
      
      .telegram-icon {
        width: 20px;
        height: 20px;
        font-size: 14px;
      }
      
      .sync-status {
        top: 10px;
        right: 10px;
        font-size: 11px;
        padding: 6px 12px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Sync Status -->
  <div id="sync-status" class="sync-status">
   ğŸ’¾ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
  </div><!-- Login Screen -->
  <div id="login-screen" class="login-screen">
   <div class="login-container">
    <div class="login-header">
     <h1>ğŸ” ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h1>
     <p>Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ØŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
    </div>
    <form id="login-form" onsubmit="handleLogin(event)">
     <div class="form-group"><label for="password-input">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label> <input type="password" id="password-input" required placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autofocus>
     </div><button type="submit" class="btn btn-primary" id="login-btn" style="width: 100%;">ÙˆØ±ÙˆØ¯</button>
     <div id="login-error" class="login-error" style="display: none;"></div>
    </form>
   </div>
  </div>
  <div class="container" id="main-app" style="display: none;">
   <div class="data-info"><strong>ğŸ“± Ù†Ø³Ø®Ù‡ Ø§Ø´ØªØ±Ø§Ú©ÛŒ GitHub Pages</strong><br>
     Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
   </div>
   <div class="header">
    <h1 id="app-title">Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ù…</h1>
    <p id="app-subtitle">Ø³ÛŒØ³ØªÙ… Ø¬Ø§Ù…Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ÙˆØ§Ù…â€ŒÙ‡Ø§</p>
    <div class="header-actions"><button class="btn btn-success" onclick="exportAllData()" style="font-size: 14px; padding: 8px 16px;">ğŸ“¤ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</button> <button class="btn btn-warning" onclick="importAllData()" style="font-size: 14px; padding: 8px 16px;">ğŸ“¥ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</button> <button class="btn btn-secondary" onclick="openChangePasswordModal()" style="font-size: 14px; padding: 8px 16px;">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</button> <button class="btn btn-danger" onclick="logout()" style="font-size: 14px; padding: 8px 16px;">Ø®Ø±ÙˆØ¬</button>
    </div>
   </div>
   <div class="stats-grid">
    <div class="stat-card">
     <h3>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ÙˆØ§Ù…â€ŒÙ‡Ø§</h3>
     <div class="value" id="total-loans">
      0
     </div>
    </div>
    <div class="stat-card">
     <h3>Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§Ù…â€ŒÙ‡Ø§</h3>
     <div class="value" id="total-amount">
      0 ØªÙˆÙ…Ø§Ù†
     </div>
    </div>
    <div class="stat-card overdue">
     <h3>Ø§Ù‚Ø³Ø§Ø· Ø¹Ù‚Ø¨â€ŒØ§ÙØªØ§Ø¯Ù‡</h3>
     <div class="value" id="overdue-count">
      0 Ù‚Ø³Ø·
     </div>
     <div style="font-size: 14px; margin-top: 5px;" id="overdue-amount">
      0 ØªÙˆÙ…Ø§Ù†
     </div>
    </div>
    <div class="stat-card upcoming">
     <h3>Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ù‚Ø³Ø·</h3>
     <div class="value" id="next-payment">
      -
     </div>
    </div>
   </div>
   <div class="loans-section">
    <div class="tabs"><button class="tab active" onclick="switchTab('active')">ÙˆØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</button> <button class="tab" onclick="switchTab('archived')">Ø¢Ø±Ø´ÛŒÙˆ</button>
    </div>
    <div class="tab-content active" id="active-tab">
     <div class="section-header">
      <h2 id="dashboard-title">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆØ§Ù…â€ŒÙ‡Ø§</h2><button class="btn btn-primary" onclick="openAddLoanModal()" id="add-loan-btn">+ Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯</button>
     </div>
     <div id="loans-list"></div>
    </div>
    <div class="tab-content" id="archived-tab">
     <div class="section-header">
      <h2>ÙˆØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡</h2>
     </div>
     <div id="archived-loans-list"></div>
    </div>
   </div>
  </div><!-- Add Loan Modal -->
  <div id="add-loan-modal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2>Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯</h2><button class="close-btn" onclick="closeAddLoanModal()">Ã—</button>
    </div>
    <form id="add-loan-form" onsubmit="handleAddLoan(event)">
     <div class="form-group"><label for="loan-name">Ù†Ø§Ù… ÙˆØ§Ù… *</label> <input type="text" id="loan-name" required>
     </div>
     <div class="form-group"><label for="bank-name">Ø¨Ø§Ù†Ú© ÙˆØ§Ù… *</label> <input type="text" id="bank-name" required>
     </div>
     <div class="form-group"><label for="owner-name">ØµØ§Ø­Ø¨ ÙˆØ§Ù… *</label> <input type="text" id="owner-name" required>
     </div>
     <div class="form-group"><label>Ø¶Ø§Ù…Ù†ÛŒÙ†</label>
      <div id="guarantors-list">
       <div class="guarantor-item"><input type="text" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¶Ø§Ù…Ù†" class="guarantor-input"> <button type="button" class="btn btn-danger" onclick="removeGuarantor(this)" style="padding: 8px 12px;">Ø­Ø°Ù</button>
       </div>
      </div><button type="button" class="btn btn-secondary" onclick="addGuarantor()" style="margin-top: 10px;">+ Ø§ÙØ²ÙˆØ¯Ù† Ø¶Ø§Ù…Ù†</button>
     </div>
     <div class="form-group"><label for="loan-amount">Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†) *</label> <input type="text" id="loan-amount" required oninput="formatNumber(this); updateEndDateAndInstallments();">
     </div>
     <div class="form-group"><label for="interest-rate">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ (%) *</label> <input type="number" id="interest-rate" step="0.1" required oninput="updateEndDateAndInstallments()">
     </div>
     <div class="form-group"><label for="installment-count">ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø· *</label> <input type="number" id="installment-count" min="1" required oninput="updateEndDateAndInstallments()">
     </div>
     <div class="form-group"><label for="start-date">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ *</label> <input type="text" id="start-date" readonly required onclick="openCalendar('start')" oninput="updateEndDateAndInstallments()">
      <div id="start-calendar" style="display: none;"></div>
     </div>
     <div class="form-group"><label for="end-date">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† *</label> <input type="text" id="end-date" readonly required onclick="openCalendar('end')">
      <div id="end-calendar" style="display: none;"></div>
     </div>
     <div class="form-group">
      <div class="checkbox-group"><input type="checkbox" id="custom-payments" onchange="toggleCustomPayments()"> <label for="custom-payments">Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</label>
      </div>
     </div>
     <div id="custom-payments-section" style="display: none;">
      <div class="form-group"><label>ØªØ§Ø±ÛŒØ® Ùˆ Ù…Ø¨Ù„Øº Ø§Ù‚Ø³Ø§Ø·</label>
       <div id="installments-list"></div>
      </div>
     </div>
     <div class="form-group"><label for="description">ØªÙˆØ¶ÛŒØ­Ø§Øª</label> <textarea id="description"></textarea>
     </div>
     <div style="display: flex; gap: 10px; justify-content: flex-end;"><button type="button" class="btn btn-secondary" onclick="closeAddLoanModal()">Ø§Ù†ØµØ±Ø§Ù</button> <button type="submit" class="btn btn-primary" id="submit-loan-btn">Ø«Ø¨Øª ÙˆØ§Ù…</button>
     </div>
    </form>
   </div>
  </div><!-- Payments Modal -->
  <div id="payments-modal" class="modal">
   <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
     <h2 id="payments-modal-title">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·</h2><button class="close-btn" onclick="closePaymentsModal()">Ã—</button>
    </div>
    <div id="payments-content"></div>
   </div>
  </div><!-- Payment Detail Modal -->
  <div id="payment-detail-modal" class="modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2>Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª</h2><button class="close-btn" onclick="closePaymentDetailModal()">Ã—</button>
    </div>
    <form id="payment-detail-form" onsubmit="handlePaymentSubmit(event)">
     <div class="form-group"><label>Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø³Ø·</label> <input type="text" id="payment-installment-number" readonly>
     </div>
     <div class="form-group"><label for="payer-name">Ù†Ø§Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡ *</label> <input type="text" id="payer-name" required placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡">
     </div>
     <div class="form-group"><label for="payment-amount-input">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª (ØªÙˆÙ…Ø§Ù†) *</label> <input type="text" id="payment-amount-input" required oninput="formatNumber(this)">
     </div>
     <div class="form-group"><label for="payment-source">Ù…Ù†Ø¨Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª *</label> <input type="text" id="payment-source" required placeholder="Ù…Ø«Ø§Ù„: Ø­Ø³Ø§Ø¨ Ø¬Ø§Ø±ÛŒØŒ Ú©Ø§Ø±Øª Ø¨Ø§Ù†Ú©ÛŒØŒ Ù†Ù‚Ø¯">
     </div>
     <div class="form-group"><label for="payment-date">ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª *</label> <input type="text" id="payment-date" readonly required onclick="openCalendar('payment')">
      <div id="payment-calendar" style="display: none;"></div>
     </div>
     <div class="form-group"><label for="payment-notes">ØªÙˆØ¶ÛŒØ­Ø§Øª</label> <textarea id="payment-notes" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>
     </div>
     <div style="display: flex; gap: 10px; justify-content: flex-end;"><button type="button" class="btn btn-secondary" onclick="closePaymentDetailModal()">Ø§Ù†ØµØ±Ø§Ù</button> <button type="submit" class="btn btn-success" id="payment-submit-btn">ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª</button>
     </div>
    </form>
   </div>
  </div><!-- Confirm Modal -->
  <div id="confirm-modal" class="modal">
   <div class="confirm-dialog">
    <h3 id="confirm-title">ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù</h3>
    <p id="confirm-message">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
    <div class="confirm-actions"><button class="btn btn-secondary" onclick="closeConfirmModal()">Ø§Ù†ØµØ±Ø§Ù</button> <button class="btn btn-danger" id="confirm-action-btn">ØªØ§ÛŒÛŒØ¯</button>
    </div>
   </div>
  </div><!-- Unpay Confirmation Modal -->
  <div id="unpay-confirm-modal" class="modal">
   <div class="confirm-dialog">
    <h3 style="color: #f39c12;">ØªØ§ÛŒÛŒØ¯ Ø¨Ø±Ú¯Ø´Øª Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
    <p id="unpay-confirm-message">Ø¢ÛŒØ§ Ø§Ø² Ø¨Ø±Ú¯Ø´Øª Ø§ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ</p>
    <div id="unpay-confirm-steps" style="margin: 20px 0; text-align: right;">
     <div style="margin-bottom: 10px;"><span id="step1" style="color: #999;">Ù…Ø±Ø­Ù„Ù‡ 1: ØªØ§ÛŒÛŒØ¯ Ø§ÙˆÙ„ÛŒÙ‡</span>
     </div>
     <div style="margin-bottom: 10px;"><span id="step2" style="color: #999;">Ù…Ø±Ø­Ù„Ù‡ 2: ØªØ§ÛŒÛŒØ¯ Ù…Ø¬Ø¯Ø¯</span>
     </div>
     <div style="margin-bottom: 10px;"><span id="step3" style="color: #999;">Ù…Ø±Ø­Ù„Ù‡ 3: ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ</span>
     </div>
    </div>
    <div class="confirm-actions"><button class="btn btn-secondary" onclick="closeUnpayConfirmModal()">Ø§Ù†ØµØ±Ø§Ù</button> <button class="btn btn-warning" id="unpay-confirm-btn" onclick="handleUnpayConfirmation()">ØªØ§ÛŒÛŒØ¯ Ù…Ø±Ø­Ù„Ù‡ 1</button>
    </div>
   </div>
  </div><!-- Change Password Modal -->
  <div id="change-password-modal" class="modal">
   <div class="modal-content" style="max-width: 400px;">
    <div class="modal-header">
     <h2>ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</h2><button class="close-btn" onclick="closeChangePasswordModal()">Ã—</button>
    </div>
    <form id="change-password-form" onsubmit="handleChangePassword(event)">
     <div class="form-group"><label for="current-password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙØ¹Ù„ÛŒ *</label> <input type="password" id="current-password" required placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙØ¹Ù„ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
     </div>
     <div class="form-group"><label for="new-password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ *</label> <input type="password" id="new-password" required placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" minlength="4">
     </div>
     <div class="form-group"><label for="confirm-password">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ *</label> <input type="password" id="confirm-password" required placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" minlength="4">
     </div>
     <div id="password-error" class="login-error" style="display: none;"></div>
     <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;"><button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">Ø§Ù†ØµØ±Ø§Ù</button> <button type="submit" class="btn btn-primary" id="change-password-btn">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</button>
     </div>
    </form>
   </div>
  </div><!-- Import Data Modal -->
  <div id="import-modal" class="modal">
   <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
     <h2>ğŸ“¥ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h2><button class="close-btn" onclick="closeImportModal()">Ã—</button>
    </div>
    <div style="margin-bottom: 20px;">
     <p style="color: #666; margin-bottom: 15px;">ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (.json) Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p><input type="file" id="import-file" accept=".json" style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9fa;">
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;"><button class="btn btn-secondary" onclick="closeImportModal()">Ø§Ù†ØµØ±Ø§Ù</button> <button class="btn btn-success" onclick="processImportFile()">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
    </div>
   </div>
  </div><!-- Developer Credit -->
  <div class="developer-credit"><span>ÙˆØ­ÛŒØ¯ Ù…ÙˆÙ…Ù†ÛŒ</span> <a href="https://t.me/gvssm_bl" target="_blank" rel="noopener noreferrer" class="telegram-icon"> âœˆ </a>
  </div><!-- Hidden file input for import --> <input type="file" id="hidden-import-input" accept=".json" style="display: none;" onchange="handleFileImport(event)">
  <script>
    // Global variables
    let allLoans = [];
    let currentLoan = null;
    let currentInstallmentIndex = null;
    let deleteTarget = null;
    let currentCalendarType = null;
    let currentTab = 'active';
    let currentCalendarYear = null;
    let currentCalendarMonth = null;
    let editingLoan = null;
    let isLoggedIn = false;
    let currentPassword = '4414';
    
    // LocalStorage keys
    const STORAGE_KEYS = {
      LOANS: 'loan_manager_loans',
      PASSWORD: 'loan_manager_password',
      LAST_SYNC: 'loan_manager_last_sync'
    };
    
    // Initialize app
    function initApp() {
      loadDataFromStorage();
      renderLoans();
      updateStats();
      updateSyncStatus();
    }
    
    // Storage functions
    function saveDataToStorage() {
      try {
        localStorage.setItem(STORAGE_KEYS.LOANS, JSON.stringify(allLoans));
        localStorage.setItem(STORAGE_KEYS.LAST_SYNC, new Date().toISOString());
        updateSyncStatus();
      } catch (error) {
        console.error('Error saving to storage:', error);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'error');
      }
    }
    
    function loadDataFromStorage() {
      try {
        const storedLoans = localStorage.getItem(STORAGE_KEYS.LOANS);
        const storedPassword = localStorage.getItem(STORAGE_KEYS.PASSWORD);
        
        if (storedLoans) {
          allLoans = JSON.parse(storedLoans);
        }
        
        if (storedPassword) {
          currentPassword = storedPassword;
        }
      } catch (error) {
        console.error('Error loading from storage:', error);
        allLoans = [];
      }
    }
    
    function updateSyncStatus() {
      const syncStatus = document.getElementById('sync-status');
      const lastSync = localStorage.getItem(STORAGE_KEYS.LAST_SYNC);
      
      if (lastSync) {
        const syncDate = new Date(lastSync);
        const now = new Date();
        const diffMinutes = Math.floor((now - syncDate) / (1000 * 60));
        
        if (diffMinutes < 1) {
          syncStatus.textContent = 'ğŸ’¾ Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯';
        } else if (diffMinutes < 60) {
          syncStatus.textContent = `ğŸ’¾ ${diffMinutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`;
        } else {
          const diffHours = Math.floor(diffMinutes / 60);
          syncStatus.textContent = `ğŸ’¾ ${diffHours} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`;
        }
      } else {
        syncStatus.textContent = 'ğŸ’¾ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯';
      }
    }
    
    // Login functions
    function handleLogin(event) {
      event.preventDefault();
      
      const passwordInput = document.getElementById('password-input');
      const loginBtn = document.getElementById('login-btn');
      const loginError = document.getElementById('login-error');
      
      const enteredPassword = passwordInput.value;
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...';
      
      setTimeout(() => {
        if (enteredPassword === currentPassword) {
          isLoggedIn = true;
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('main-app').style.display = 'block';
          showToast('Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! ğŸ‰', 'success');
          initApp();
        } else {
          loginError.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!';
          loginError.style.display = 'block';
          passwordInput.value = '';
          passwordInput.focus();
        }
        
        loginBtn.disabled = false;
        loginBtn.textContent = 'ÙˆØ±ÙˆØ¯';
      }, 1000);
    }
    
    function logout() {
      isLoggedIn = false;
      document.getElementById('main-app').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('password-input').value = '';
      document.getElementById('login-error').style.display = 'none';
      showToast('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'success');
    }
    
    function openChangePasswordModal() {
      document.getElementById('change-password-modal').classList.add('active');
      document.getElementById('change-password-form').reset();
      document.getElementById('password-error').style.display = 'none';
    }
    
    function closeChangePasswordModal() {
      document.getElementById('change-password-modal').classList.remove('active');
    }
    
    function handleChangePassword(event) {
      event.preventDefault();
      
      const currentPasswordInput = document.getElementById('current-password');
      const newPasswordInput = document.getElementById('new-password');
      const confirmPasswordInput = document.getElementById('confirm-password');
      const passwordError = document.getElementById('password-error');
      const changeBtn = document.getElementById('change-password-btn');
      
      const currentPasswordValue = currentPasswordInput.value;
      const newPasswordValue = newPasswordInput.value;
      const confirmPasswordValue = confirmPasswordInput.value;
      
      // Reset error
      passwordError.style.display = 'none';
      
      // Validate current password
      if (currentPasswordValue !== currentPassword) {
        passwordError.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙØ¹Ù„ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!';
        passwordError.style.display = 'block';
        return;
      }
      
      // Validate new password
      if (newPasswordValue.length < 4) {
        passwordError.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 4 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯!';
        passwordError.style.display = 'block';
        return;
      }
      
      // Validate password confirmation
      if (newPasswordValue !== confirmPasswordValue) {
        passwordError.textContent = 'ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯!';
        passwordError.style.display = 'block';
        return;
      }
      
      // Change password
      changeBtn.disabled = true;
      changeBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØºÛŒÛŒØ±...';
      
      setTimeout(() => {
        currentPassword = newPasswordValue;
        localStorage.setItem(STORAGE_KEYS.PASSWORD, currentPassword);
        showToast('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯! ğŸ”', 'success');
        closeChangePasswordModal();
        
        changeBtn.disabled = false;
        changeBtn.textContent = 'ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±';
      }, 1000);
    }
    
    // Data export/import functions
    function exportAllData() {
      try {
        const exportData = {
          loans: allLoans,
          password: currentPassword,
          exportDate: new Date().toISOString(),
          version: '1.0'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `loan_manager_backup_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showToast('Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! ğŸ“¤', 'success');
      } catch (error) {
        console.error('Export error:', error);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ', 'error');
      }
    }
    
    function importAllData() {
      document.getElementById('import-modal').classList.add('active');
    }
    
    function closeImportModal() {
      document.getElementById('import-modal').classList.remove('active');
      document.getElementById('import-file').value = '';
    }
    
    function processImportFile() {
      const fileInput = document.getElementById('import-file');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'warning');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importData = JSON.parse(e.target.result);
          
          if (importData.loans && Array.isArray(importData.loans)) {
            // Add unique IDs to imported loans
            const importedLoans = importData.loans.map(loan => ({
              ...loan,
              __backendId: loan.__backendId || generateUniqueId()
            }));
            
            allLoans = importedLoans;
            
            if (importData.password) {
              currentPassword = importData.password;
              localStorage.setItem(STORAGE_KEYS.PASSWORD, currentPassword);
            }
            
            saveDataToStorage();
            renderLoans();
            updateStats();
            
            closeImportModal();
            showToast(`${importedLoans.length} ÙˆØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯! ğŸ“¥`, 'success');
          } else {
            showToast('ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'error');
          }
        } catch (error) {
          console.error('Import error:', error);
          showToast('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†', 'error');
        }
      };
      
      reader.readAsText(file);
    }
    
    function generateUniqueId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    // Utility functions
    function formatNumber(input) {
      let value = input.value.replace(/,/g, '');
      if (!isNaN(value) && value !== '') {
        input.value = Number(value).toLocaleString('en-US');
      }
    }
    
    function parseNumber(str) {
      if (!str) return 0;
      return Number(str.toString().replace(/,/g, ''));
    }
    
    function formatCurrency(amount) {
      return Number(amount).toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†';
    }
    
    function toJalali(gregorianDate) {
      try {
        const date = new Date(gregorianDate);
        const jDate = jalaali.toJalaali(date.getFullYear(), date.getMonth() + 1, date.getDate());
        return `${jDate.jy}/${String(jDate.jm).padStart(2, '0')}/${String(jDate.jd).padStart(2, '0')}`;
      } catch (error) {
        console.error('Error converting to Jalali:', error);
        return '1403/01/01';
      }
    }
    
    function toGregorian(jalaliStr) {
      try {
        if (!jalaliStr || typeof jalaliStr !== 'string') {
          return new Date().toISOString();
        }
        
        const parts = jalaliStr.split('/');
        if (parts.length !== 3) {
          return new Date().toISOString();
        }
        
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]);
        const day = parseInt(parts[2]);
        
        if (isNaN(year) || isNaN(month) || isNaN(day)) {
          return new Date().toISOString();
        }
        
        const gDate = jalaali.toGregorian(year, month, day);
        return new Date(gDate.gy, gDate.gm - 1, gDate.gd).toISOString();
      } catch (error) {
        console.error('Error converting to Gregorian:', error, jalaliStr);
        return new Date().toISOString();
      }
    }
    
    function calculateInstallmentAmount(principal, rate, periods) {
      if (rate === 0) return Math.round(principal / periods);
      
      const monthlyRate = rate / 100 / 12;
      const totalAmount = principal * Math.pow(1 + monthlyRate, periods);
      return Math.round(totalAmount / periods);
    }
    
    // Guarantor management
    function addGuarantor() {
      const guarantorsList = document.getElementById('guarantors-list');
      const guarantorItem = document.createElement('div');
      guarantorItem.className = 'guarantor-item';
      guarantorItem.innerHTML = `
        <input type="text" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¶Ø§Ù…Ù†" class="guarantor-input">
        <button type="button" class="btn btn-danger" onclick="removeGuarantor(this)" style="padding: 8px 12px;">Ø­Ø°Ù</button>
      `;
      guarantorsList.appendChild(guarantorItem);
    }
    
    function removeGuarantor(button) {
      const guarantorsList = document.getElementById('guarantors-list');
      if (guarantorsList.children.length > 1) {
        button.parentElement.remove();
      } else {
        showToast('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙÛŒÙ„Ø¯ Ø¶Ø§Ù…Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯', 'warning');
      }
    }
    
    function getGuarantors() {
      const inputs = document.querySelectorAll('.guarantor-input');
      const guarantors = [];
      inputs.forEach(input => {
        if (input.value.trim()) {
          guarantors.push(input.value.trim());
        }
      });
      return guarantors;
    }
    
    function setGuarantors(guarantors) {
      const guarantorsList = document.getElementById('guarantors-list');
      guarantorsList.innerHTML = '';
      
      if (!guarantors || guarantors.length === 0) {
        guarantors = [''];
      }
      
      guarantors.forEach(guarantor => {
        const guarantorItem = document.createElement('div');
        guarantorItem.className = 'guarantor-item';
        guarantorItem.innerHTML = `
          <input type="text" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¶Ø§Ù…Ù†" class="guarantor-input" value="${guarantor || ''}">
          <button type="button" class="btn btn-danger" onclick="removeGuarantor(this)" style="padding: 8px 12px;">Ø­Ø°Ù</button>
        `;
        guarantorsList.appendChild(guarantorItem);
      });
    }
    
    // Date and installment calculations
    function updateEndDateAndInstallments() {
      const startDate = document.getElementById('start-date').value;
      const installmentCount = parseInt(document.getElementById('installment-count').value);
      
      if (startDate && installmentCount && installmentCount > 0) {
        try {
          const startParts = startDate.split('/');
          const startJalali = {
            jy: parseInt(startParts[0]),
            jm: parseInt(startParts[1]),
            jd: parseInt(startParts[2])
          };
          
          let endYear = startJalali.jy;
          let endMonth = startJalali.jm + installmentCount;
          
          while (endMonth > 12) {
            endMonth -= 12;
            endYear++;
          }
          
          const endDate = `${endYear}/${String(endMonth).padStart(2, '0')}/${String(startJalali.jd).padStart(2, '0')}`;
          document.getElementById('end-date').value = endDate;
          
          if (document.getElementById('custom-payments').checked) {
            updateInstallmentsList();
          }
        } catch (error) {
          console.error('Error updating end date:', error);
        }
      }
    }
    
    function updateInstallmentsList() {
      const startDate = document.getElementById('start-date').value;
      const installmentCount = parseInt(document.getElementById('installment-count').value);
      const amount = parseNumber(document.getElementById('loan-amount').value || '0');
      const interestRate = parseFloat(document.getElementById('interest-rate').value || '0');
      
      if (!startDate || !installmentCount || !amount) return;
      
      try {
        const installmentAmount = calculateInstallmentAmount(amount, interestRate, installmentCount);
        const list = document.getElementById('installments-list');
        
        const startParts = startDate.split('/');
        const startJalali = {
          jy: parseInt(startParts[0]),
          jm: parseInt(startParts[1]),
          jd: parseInt(startParts[2])
        };
        
        let html = '<div class="installments-grid">';
        for (let i = 0; i < installmentCount; i++) {
          let installmentYear = startJalali.jy;
          let installmentMonth = startJalali.jm + i;
          
          while (installmentMonth > 12) {
            installmentMonth -= 12;
            installmentYear++;
          }
          
          const jalaliDate = `${installmentYear}/${String(installmentMonth).padStart(2, '0')}/${String(startJalali.jd).padStart(2, '0')}`;
          
          html += `
            <div class="installment-item">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong>Ù‚Ø³Ø· ${i + 1}</strong>
                <span>${jalaliDate}</span>
              </div>
              <input type="text" value="${installmentAmount.toLocaleString('en-US')}" 
                     oninput="formatNumber(this)" 
                     style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px;"
                     data-installment-index="${i}">
            </div>
          `;
        }
        html += '</div>';
        list.innerHTML = html;
      } catch (error) {
        console.error('Error updating installments list:', error);
      }
    }
    
    function toggleCustomPayments() {
      const checked = document.getElementById('custom-payments').checked;
      const section = document.getElementById('custom-payments-section');
      section.style.display = checked ? 'block' : 'none';
      
      if (checked) {
        updateInstallmentsList();
      }
    }
    
    // Calendar functions
    function openCalendar(type) {
      currentCalendarType = type;
      const calendarId = type + '-calendar';
      const calendar = document.getElementById(calendarId);
      
      if (calendar.style.display === 'none') {
        calendar.style.display = 'block';
        const now = new Date();
        const jNow = jalaali.toJalaali(now.getFullYear(), now.getMonth() + 1, now.getDate());
        renderCalendar(type, jNow.jy, jNow.jm);
      } else {
        calendar.style.display = 'none';
      }
    }
    
    function renderCalendar(type, year, month) {
      try {
        const now = new Date();
        const jNow = jalaali.toJalaali(now.getFullYear(), now.getMonth() + 1, now.getDate());
        
        if (!year) year = jNow.jy;
        if (!month) month = jNow.jm;
        
        currentCalendarYear = year;
        currentCalendarMonth = month;
        
        const calendarId = type + '-calendar';
        const calendar = document.getElementById(calendarId);
        
        const monthNames = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
        const weekDays = ['Ø´', 'ÛŒ', 'Ø¯', 'Ø³', 'Ú†', 'Ù¾', 'Ø¬'];
        
        const daysInMonth = jalaali.jalaaliMonthLength(year, month);
        const firstDay = jalaali.toGregorian(year, month, 1);
        const firstDayOfWeek = new Date(firstDay.gy, firstDay.gm - 1, firstDay.gd).getDay();
        const adjustedFirstDay = (firstDayOfWeek + 1) % 7;
        
        let html = `
          <div class="calendar">
            <div class="calendar-header">
              <button type="button" onclick="changeMonth('${type}', -1); event.stopPropagation();">â®</button>
              <span class="calendar-title" onclick="toggleYearMonthSelector('${type}'); event.stopPropagation();">${monthNames[month - 1]} ${year}</span>
              <button type="button" onclick="changeMonth('${type}', 1); event.stopPropagation();">â¯</button>
            </div>
            
            <div class="year-month-selector" id="${type}-year-month-selector">
              <div class="year-month-row">
                <label>Ø³Ø§Ù„:</label>
                <select id="${type}-year-select" onchange="updateCalendarFromSelector('${type}')">
        `;
        
        for (let y = year - 10; y <= year + 10; y++) {
          html += `<option value="${y}" ${y === year ? 'selected' : ''}>${y}</option>`;
        }
        
        html += `
                </select>
                <label>Ù…Ø§Ù‡:</label>
                <select id="${type}-month-select" onchange="updateCalendarFromSelector('${type}')">
        `;
        
        monthNames.forEach((name, index) => {
          html += `<option value="${index + 1}" ${(index + 1) === month ? 'selected' : ''}>${name}</option>`;
        });
        
        html += `
                </select>
              </div>
            </div>
            
            <div class="calendar-grid">
        `;
        
        weekDays.forEach(day => {
          html += `<div class="calendar-weekday">${day}</div>`;
        });
        
        for (let i = 0; i < adjustedFirstDay; i++) {
          html += '<div class="calendar-day disabled"></div>';
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
          html += `<div class="calendar-day" onclick="selectDate('${type}', '${dateStr}'); event.stopPropagation();">${day}</div>`;
        }
        
        html += '</div></div>';
        calendar.innerHTML = html;
      } catch (error) {
        console.error('Error rendering calendar:', error);
      }
    }
    
    function changeMonth(type, direction) {
      let newMonth = currentCalendarMonth + direction;
      let newYear = currentCalendarYear;
      
      if (newMonth > 12) {
        newMonth = 1;
        newYear++;
      } else if (newMonth < 1) {
        newMonth = 12;
        newYear--;
      }
      
      renderCalendar(type, newYear, newMonth);
    }
    
    function toggleYearMonthSelector(type) {
      const selector = document.getElementById(type + '-year-month-selector');
      selector.classList.toggle('active');
    }
    
    function updateCalendarFromSelector(type) {
      const yearSelect = document.getElementById(type + '-year-select');
      const monthSelect = document.getElementById(type + '-month-select');
      
      const selectedYear = parseInt(yearSelect.value);
      const selectedMonth = parseInt(monthSelect.value);
      
      renderCalendar(type, selectedYear, selectedMonth);
      
      const selector = document.getElementById(type + '-year-month-selector');
      selector.classList.remove('active');
    }
    
    function selectDate(type, dateStr) {
      const inputId = type === 'start' ? 'start-date' : type === 'end' ? 'end-date' : 'payment-date';
      document.getElementById(inputId).value = dateStr;
      document.getElementById(type + '-calendar').style.display = 'none';
      
      if (type === 'start') {
        updateEndDateAndInstallments();
      }
    }
    
    // Modal functions
    function openAddLoanModal() {
      editingLoan = null;
      document.getElementById('add-loan-modal').classList.add('active');
      document.getElementById('add-loan-form').reset();
      document.getElementById('custom-payments-section').style.display = 'none';
      document.querySelector('#add-loan-modal h2').textContent = 'Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯';
      document.getElementById('submit-loan-btn').textContent = 'Ø«Ø¨Øª ÙˆØ§Ù…';
      setGuarantors(['']);
    }
    
    function closeAddLoanModal() {
      document.getElementById('add-loan-modal').classList.remove('active');
    }
    
    function editLoan(loanId) {
      const loan = allLoans.find(l => l.__backendId === loanId);
      if (!loan) return;
      
      editingLoan = loan;
      
      try {
        document.getElementById('loan-name').value = loan.loan_name || '';
        document.getElementById('bank-name').value = loan.bank_name || '';
        document.getElementById('owner-name').value = loan.owner_name || '';
        document.getElementById('loan-amount').value = parseFloat(loan.loan_amount || '0').toLocaleString('en-US');
        document.getElementById('interest-rate').value = loan.interest_rate || '0';
        document.getElementById('installment-count').value = loan.installment_count || '1';
        document.getElementById('start-date').value = toJalali(loan.start_date);
        document.getElementById('end-date').value = toJalali(loan.end_date);
        document.getElementById('custom-payments').checked = loan.custom_payments === "1";
        document.getElementById('description').value = loan.description || '';
        
        let guarantors = [];
        try {
          guarantors = loan.guarantors ? JSON.parse(loan.guarantors) : [''];
        } catch (e) {
          guarantors = [''];
        }
        setGuarantors(guarantors);
        
        if (loan.custom_payments === "1") {
          document.getElementById('custom-payments-section').style.display = 'block';
          updateInstallmentsList();
        }
        
        document.querySelector('#add-loan-modal h2').textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ ÙˆØ§Ù…';
        document.getElementById('submit-loan-btn').textContent = 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ§Ù…';
        document.getElementById('add-loan-modal').classList.add('active');
      } catch (error) {
        console.error('Error editing loan:', error);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ù…', 'error');
      }
    }
    
    // Loan submission with automatic installments generation
    function handleAddLoan(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submit-loan-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';
      
      try {
        // Get form values
        const loanName = document.getElementById('loan-name').value || 'ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯';
        const bankName = document.getElementById('bank-name').value || 'Ø¨Ø§Ù†Ú©';
        const ownerName = document.getElementById('owner-name').value || 'ØµØ§Ø­Ø¨ ÙˆØ§Ù…';
        const loanAmount = parseNumber(document.getElementById('loan-amount').value || '1000000');
        const interestRate = parseFloat(document.getElementById('interest-rate').value || '18');
        const installmentCount = parseInt(document.getElementById('installment-count').value || '12');
        const startDate = document.getElementById('start-date').value || '1403/01/01';
        const endDate = document.getElementById('end-date').value || '1403/12/29';
        const description = document.getElementById('description').value || '';
        const customPayments = document.getElementById('custom-payments').checked;
        
        // Get guarantors
        const guarantors = getGuarantors();
        
        // Generate installments
        let installments = [];
        
        if (customPayments) {
          // Get custom installments from form
          const customInputs = document.querySelectorAll('#installments-list input[data-installment-index]');
          const startParts = startDate.split('/');
          const startJalali = {
            jy: parseInt(startParts[0]),
            jm: parseInt(startParts[1]),
            jd: parseInt(startParts[2])
          };
          
          customInputs.forEach((input, index) => {
            let installmentYear = startJalali.jy;
            let installmentMonth = startJalali.jm + index;
            
            while (installmentMonth > 12) {
              installmentMonth -= 12;
              installmentYear++;
            }
            
            const jalaliDate = `${installmentYear}/${String(installmentMonth).padStart(2, '0')}/${String(startJalali.jd).padStart(2, '0')}`;
            const gregorianDate = toGregorian(jalaliDate);
            
            installments.push({
              number: index + 1,
              amount: parseNumber(input.value || '0').toString(),
              dueDate: gregorianDate,
              paid: "0"
            });
          });
        } else {
          // Generate automatic installments
          const installmentAmount = calculateInstallmentAmount(loanAmount, interestRate, installmentCount);
          const startParts = startDate.split('/');
          const startJalali = {
            jy: parseInt(startParts[0]),
            jm: parseInt(startParts[1]),
            jd: parseInt(startParts[2])
          };
          
          for (let i = 0; i < installmentCount; i++) {
            let installmentYear = startJalali.jy;
            let installmentMonth = startJalali.jm + i;
            
            while (installmentMonth > 12) {
              installmentMonth -= 12;
              installmentYear++;
            }
            
            const jalaliDate = `${installmentYear}/${String(installmentMonth).padStart(2, '0')}/${String(startJalali.jd).padStart(2, '0')}`;
            const gregorianDate = toGregorian(jalaliDate);
            
            installments.push({
              number: i + 1,
              amount: installmentAmount.toString(),
              dueDate: gregorianDate,
              paid: "0"
            });
          }
        }
        
        // Create loan object
        const loan = {
          loan_name: loanName,
          bank_name: bankName,
          owner_name: ownerName,
          guarantors: JSON.stringify(guarantors),
          loan_amount: loanAmount.toString(),
          interest_rate: interestRate.toString(),
          installment_count: installmentCount.toString(),
          start_date: toGregorian(startDate),
          end_date: toGregorian(endDate),
          custom_payments: customPayments ? "1" : "0",
          description: description,
          installments: JSON.stringify(installments),
          archived: "0",
          created_at: new Date().toISOString(),
          __backendId: editingLoan ? editingLoan.__backendId : generateUniqueId()
        };
        
        // Submit loan
        if (editingLoan) {
          const index = allLoans.findIndex(l => l.__backendId === editingLoan.__backendId);
          if (index !== -1) {
            allLoans[index] = loan;
          }
        } else {
          allLoans.push(loan);
        }
        
        saveDataToStorage();
        renderLoans();
        updateStats();
        
        showToast(editingLoan ? 'ÙˆØ§Ù… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯! ğŸ‰' : 'ÙˆØ§Ù… Ø«Ø¨Øª Ø´Ø¯! ğŸ‰', 'success');
        closeAddLoanModal();
        
      } catch (error) {
        console.error('Error submitting loan:', error);
        showToast('Ø®Ø·Ø§! Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†', 'error');
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = editingLoan ? 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ§Ù…' : 'Ø«Ø¨Øª ÙˆØ§Ù…';
    }
    
    // Render functions
    function renderLoans() {
      const activeLoans = allLoans.filter(loan => loan.archived !== "1");
      const archivedLoans = allLoans.filter(loan => loan.archived === "1");
      
      renderLoansList('loans-list', activeLoans);
      renderLoansList('archived-loans-list', archivedLoans);
    }
    
    function renderLoansList(containerId, loans) {
      const container = document.getElementById(containerId);
      
      if (loans.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
            </svg>
            <p>Ù‡ÛŒÚ† ÙˆØ§Ù…ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      loans.forEach(loan => {
        try {
          let installments = [];
          try {
            installments = JSON.parse(loan.installments || '[]');
          } catch (e) {
            installments = [];
          }
          
          const paidCount = installments.filter(i => i.paid === "1").length;
          const totalCount = installments.length;
          const progress = totalCount > 0 ? (paidCount / totalCount) * 100 : 0;
          
          const overdueInstallments = installments.filter(i => {
            if (i.paid === "1") return false;
            return new Date(i.dueDate) < new Date();
          });
          
          const isOverdue = overdueInstallments.length > 0;
          
          let guarantorsText = '';
          try {
            const guarantors = loan.guarantors ? JSON.parse(loan.guarantors) : [];
            guarantorsText = guarantors.filter(g => g && g.trim()).join('ØŒ ');
          } catch (e) {
            guarantorsText = '';
          }
          
          html += `
            <div class="loan-card ${isOverdue ? 'overdue' : ''}">
              <div class="loan-header">
                <h3 class="loan-title">${loan.loan_name || 'Ù†Ø§Ù… ÙˆØ§Ù…'}</h3>
                ${isOverdue ? '<span class="installment-status overdue">Ø¹Ù‚Ø¨â€ŒØ§ÙØªØ§Ø¯Ù‡</span>' : ''}
              </div>
              
              <div class="loan-info">
                <div class="info-item">
                  <span class="info-label">Ø¨Ø§Ù†Ú©</span>
                  <span class="info-value">${loan.bank_name || '-'}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ØµØ§Ø­Ø¨ ÙˆØ§Ù…</span>
                  <span class="info-value">${loan.owner_name || '-'}</span>
                </div>
                ${guarantorsText ? `
                <div class="info-item">
                  <span class="info-label">Ø¶Ø§Ù…Ù†ÛŒÙ†</span>
                  <span class="info-value">${guarantorsText}</span>
                </div>
                ` : ''}
                <div class="info-item">
                  <span class="info-label">Ù…Ø¨Ù„Øº ÙˆØ§Ù…</span>
                  <span class="info-value">${formatCurrency(parseFloat(loan.loan_amount || '0'))}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Ù†Ø±Ø® Ø³ÙˆØ¯</span>
                  <span class="info-value">${loan.interest_rate || '0'}%</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·</span>
                  <span class="info-value">${totalCount}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</span>
                  <span class="info-value">${toJalali(loan.start_date)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</span>
                  <span class="info-value">${toJalali(loan.end_date)}</span>
                </div>
              </div>
              
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <div style="text-align: center; font-size: 14px; color: #666; margin-top: 5px;">
                ${paidCount} Ø§Ø² ${totalCount} Ù‚Ø³Ø· Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡
              </div>
              
              ${loan.description ? `<p style="margin: 10px 0; color: #666; font-size: 14px;">${loan.description}</p>` : ''}
              
              <div class="loan-actions">
                <button class="btn btn-primary" onclick="openPaymentsModal('${loan.__backendId}')">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·</button>
                <button class="btn btn-warning" onclick="editLoan('${loan.__backendId}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                ${paidCount === totalCount && loan.archived !== "1" ? 
                  `<button class="btn btn-warning" onclick="archiveLoan('${loan.__backendId}')">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø¢Ø±Ø´ÛŒÙˆ</button>` : ''}
                ${loan.archived === "1" ? 
                  `<button class="btn btn-success" onclick="unarchiveLoan('${loan.__backendId}')">Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø² Ø¢Ø±Ø´ÛŒÙˆ</button>` : ''}
                <button class="btn btn-secondary" onclick="exportLoan('${loan.__backendId}', 'excel')">Ø®Ø±ÙˆØ¬ÛŒ Excel</button>
                <button class="btn btn-secondary" onclick="exportLoan('${loan.__backendId}', 'html')">Ø®Ø±ÙˆØ¬ÛŒ HTML</button>
                <button class="btn btn-danger" onclick="confirmDeleteLoan('${loan.__backendId}')">Ø­Ø°Ù</button>
              </div>
            </div>
          `;
        } catch (error) {
          console.error('Error rendering loan:', error);
        }
      });
      
      container.innerHTML = html;
    }
    
    function updateStats() {
      try {
        const activeLoans = allLoans.filter(loan => loan.archived !== "1");
        const totalLoans = activeLoans.length;
        const totalAmount = activeLoans.reduce((sum, loan) => sum + parseFloat(loan.loan_amount || '0'), 0);
        
        let overdueCount = 0;
        let overdueAmount = 0;
        let nextPayment = null;
        let nextPaymentDate = null;
        
        activeLoans.forEach(loan => {
          try {
            const installments = JSON.parse(loan.installments || '[]');
            installments.forEach(inst => {
              if (inst.paid !== "1") {
                const dueDate = new Date(inst.dueDate);
                if (dueDate < new Date()) {
                  overdueCount++;
                  overdueAmount += parseFloat(inst.amount || '0');
                }
                
                if (!nextPaymentDate || dueDate < nextPaymentDate) {
                  nextPaymentDate = dueDate;
                  nextPayment = {
                    loan: loan.loan_name,
                    amount: parseFloat(inst.amount || '0'),
                    date: dueDate
                  };
                }
              }
            });
          } catch (e) {
            console.error('Error processing loan installments:', e);
          }
        });
        
        document.getElementById('total-loans').textContent = totalLoans;
        document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
        document.getElementById('overdue-count').textContent = overdueCount + ' Ù‚Ø³Ø·';
        document.getElementById('overdue-amount').textContent = formatCurrency(overdueAmount);
        
        if (nextPayment) {
          document.getElementById('next-payment').innerHTML = `
            <div style="font-size: 16px;">${toJalali(nextPayment.date.toISOString())}</div>
            <div style="font-size: 12px; margin-top: 5px;">${nextPayment.loan} - ${formatCurrency(nextPayment.amount)}</div>
          `;
        } else {
          document.getElementById('next-payment').textContent = '-';
        }
      } catch (error) {
        console.error('Error updating stats:', error);
      }
    }
    
    // Payment functions
    function openPaymentsModal(loanId) {
      const loan = allLoans.find(l => l.__backendId === loanId);
      if (!loan) return;
      
      currentLoan = loan;
      let installments = [];
      try {
        installments = JSON.parse(loan.installments || '[]');
      } catch (e) {
        installments = [];
      }
      
      document.getElementById('payments-modal-title').textContent = `Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø· - ${loan.loan_name}`;
      
      let html = '<div class="installments-grid">';
      installments.forEach((inst, index) => {
        const isOverdue = inst.paid !== "1" && new Date(inst.dueDate) < new Date();
        const statusClass = inst.paid === "1" ? 'paid' : isOverdue ? 'overdue' : 'pending';
        const statusText = inst.paid === "1" ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ âœ“' : isOverdue ? 'Ø¹Ù‚Ø¨â€ŒØ§ÙØªØ§Ø¯Ù‡' : 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
        
        html += `
          <div class="installment-item ${inst.paid === "1" ? 'paid' : isOverdue ? 'overdue' : ''}" 
               onclick="${inst.paid === "1" ? `showPaidInstallmentOptions(${index})` : `openPaymentDetailModal(${index})`}"
               style="cursor: pointer; position: relative;">
            
            ${inst.paid === "1" ? '<div class="paid-checkmark">âœ“</div>' : ''}
            
            <div class="installment-header">
              <span class="installment-number">Ù‚Ø³Ø· ${inst.number}</span>
              <span class="installment-status ${statusClass}">${statusText}</span>
            </div>
            <div class="installment-info">
              <span>Ø³Ø±Ø±Ø³ÛŒØ¯: ${toJalali(inst.dueDate)}</span>
              <span>${formatCurrency(parseFloat(inst.amount || '0'))}</span>
            </div>
            ${inst.paid === "1" ? `
              <div style="font-size: 12px; color: #666; margin-top: 8px;">
                <div><strong>Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯Ù‡:</strong> ${inst.payerName || '-'}</div>
                <div><strong>ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª:</strong> ${toJalali(inst.paidDate)}</div>
                <div><strong>Ù…Ù†Ø¨Ø¹:</strong> ${inst.paymentSource || '-'}</div>
                ${inst.notes ? `<div><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${inst.notes}</div>` : ''}
              </div>
            ` : `
              <div style="font-size: 12px; color: #999; margin-top: 8px;">
                Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†ÛŒØ¯
              </div>
            `}
          </div>
        `;
      });
      html += '</div>';
      
      document.getElementById('payments-content').innerHTML = html;
      document.getElementById('payments-modal').classList.add('active');
    }
    
    function closePaymentsModal() {
      document.getElementById('payments-modal').classList.remove('active');
      currentLoan = null;
    }
    
    function openPaymentDetailModal(installmentIndex) {
      if (!currentLoan) return;
      
      currentInstallmentIndex = installmentIndex;
      let installments = [];
      try {
        installments = JSON.parse(currentLoan.installments || '[]');
      } catch (e) {
        installments = [];
      }
      
      if (installmentIndex >= installments.length) return;
      
      const installment = installments[installmentIndex];
      
      // Set form values
      document.getElementById('payment-installment-number').value = `Ù‚Ø³Ø· ${installment.number}`;
      document.getElementById('payer-name').value = '';
      document.getElementById('payment-amount-input').value = parseFloat(installment.amount || '0').toLocaleString('en-US');
      document.getElementById('payment-source').value = '';
      
      // Set today's date as default
      const today = new Date();
      const jToday = jalaali.toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
      const todayJalali = `${jToday.jy}/${String(jToday.jm).padStart(2, '0')}/${String(jToday.jd).padStart(2, '0')}`;
      document.getElementById('payment-date').value = todayJalali;
      
      document.getElementById('payment-notes').value = '';
      
      document.getElementById('payment-detail-modal').classList.add('active');
    }
    
    function closePaymentDetailModal() {
      document.getElementById('payment-detail-modal').classList.remove('active');
      currentInstallmentIndex = null;
    }
    
    function handlePaymentSubmit(event) {
      event.preventDefault();
      
      if (!currentLoan || currentInstallmentIndex === null) return;
      
      const submitBtn = document.getElementById('payment-submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...';
      
      try {
        const payerName = document.getElementById('payer-name').value;
        const paymentAmount = parseNumber(document.getElementById('payment-amount-input').value);
        const paymentDate = toGregorian(document.getElementById('payment-date').value);
        const paymentSource = document.getElementById('payment-source').value;
        const paymentNotes = document.getElementById('payment-notes').value;
        
        let installments = [];
        try {
          installments = JSON.parse(currentLoan.installments || '[]');
        } catch (e) {
          installments = [];
        }
        
        if (currentInstallmentIndex >= installments.length) return;
        
        installments[currentInstallmentIndex].paid = "1";
        installments[currentInstallmentIndex].payerName = payerName;
        installments[currentInstallmentIndex].paidAmount = paymentAmount.toString();
        installments[currentInstallmentIndex].paidDate = paymentDate;
        installments[currentInstallmentIndex].paymentSource = paymentSource;
        installments[currentInstallmentIndex].notes = paymentNotes;
        
        const updatedLoan = {
          ...currentLoan,
          installments: JSON.stringify(installments)
        };
        
        // Update in allLoans array
        const index = allLoans.findIndex(l => l.__backendId === currentLoan.__backendId);
        if (index !== -1) {
          allLoans[index] = updatedLoan;
          saveDataToStorage();
          renderLoans();
          updateStats();
          
          showToast('Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯! âœ…', 'success');
          closePaymentDetailModal();
          openPaymentsModal(currentLoan.__backendId);
        }
      } catch (error) {
        console.error('Error handling payment:', error);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª', 'error');
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª';
    }
    
    // Archive functions
    function archiveLoan(loanId) {
      const loan = allLoans.find(l => l.__backendId === loanId);
      if (!loan) return;
      
      const index = allLoans.findIndex(l => l.__backendId === loanId);
      if (index !== -1) {
        allLoans[index] = {
          ...loan,
          archived: "1"
        };
        
        saveDataToStorage();
        renderLoans();
        updateStats();
        showToast('ÙˆØ§Ù… Ø¨Ù‡ Ø¢Ø±Ø´ÛŒÙˆ Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯', 'success');
      }
    }
    
    function unarchiveLoan(loanId) {
      const loan = allLoans.find(l => l.__backendId === loanId);
      if (!loan) return;
      
      const index = allLoans.findIndex(l => l.__backendId === loanId);
      if (index !== -1) {
        allLoans[index] = {
          ...loan,
          archived: "0"
        };
        
        saveDataToStorage();
        renderLoans();
        updateStats();
        showToast('ÙˆØ§Ù… Ø§Ø² Ø¢Ø±Ø´ÛŒÙˆ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø´Ø¯', 'success');
      }
    }
    
    // Delete functions
    function confirmDeleteLoan(loanId) {
      deleteTarget = loanId;
      showDeleteConfirm();
    }
    
    function showDeleteConfirm() {
      document.getElementById('confirm-title').textContent = 'ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù';
      document.getElementById('confirm-message').textContent = 'Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ§Ù… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.';
      
      const confirmBtn = document.getElementById('confirm-action-btn');
      confirmBtn.onclick = () => {
        executeLoanDelete();
      };
      
      document.getElementById('confirm-modal').classList.add('active');
    }
    
    function executeLoanDelete() {
      const index = allLoans.findIndex(l => l.__backendId === deleteTarget);
      if (index !== -1) {
        allLoans.splice(index, 1);
        saveDataToStorage();
        renderLoans();
        updateStats();
        showToast('ÙˆØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
      }
      
      closeConfirmModal();
      deleteTarget = null;
    }
    
    function closeConfirmModal() {
      document.getElementById('confirm-modal').classList.remove('active');
    }
    
    // Unpay functions
    let unpayConfirmStep = 0;
    let unpayInstallmentIndex = null;
    
    function showPaidInstallmentOptions(installmentIndex) {
      if (!currentLoan) return;
      
      let installments = [];
      try {
        installments = JSON.parse(currentLoan.installments || '[]');
      } catch (e) {
        installments = [];
      }
      
      if (installmentIndex >= installments.length) return;
      
      const installment = installments[installmentIndex];
      
      // Create a temporary options menu
      const existingMenu = document.querySelector('.installment-options-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      const menu = document.createElement('div');
      menu.className = 'installment-options-menu';
      menu.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 2000;
        min-width: 300px;
        text-align: center;
      `;
      
      menu.innerHTML = `
        <h3 style="margin: 0 0 15px 0; color: #333;">Ù‚Ø³Ø· ${installment.number}</h3>
        <p style="margin: 0 0 20px 0; color: #666;">Ø§ÛŒÙ† Ù‚Ø³Ø· Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="btn btn-secondary" onclick="closeInstallmentOptions()">Ø¨Ø³ØªÙ†</button>
          <button class="btn btn-warning" onclick="startUnpayProcess(${installmentIndex})">Ø¨Ø±Ú¯Ø´Øª Ù¾Ø±Ø¯Ø§Ø®Øª</button>
        </div>
      `;
      
      document.body.appendChild(menu);
      
      // Add backdrop
      const backdrop = document.createElement('div');
      backdrop.className = 'installment-options-backdrop';
      backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1999;
      `;
      backdrop.onclick = closeInstallmentOptions;
      document.body.appendChild(backdrop);
    }
    
    function closeInstallmentOptions() {
      const menu = document.querySelector('.installment-options-menu');
      const backdrop = document.querySelector('.installment-options-backdrop');
      if (menu) menu.remove();
      if (backdrop) backdrop.remove();
    }
    
    function startUnpayProcess(installmentIndex) {
      closeInstallmentOptions();
      unpayInstallmentIndex = installmentIndex;
      unpayConfirmStep = 0;
      
      // Reset steps display
      document.getElementById('step1').style.color = '#999';
      document.getElementById('step2').style.color = '#999';
      document.getElementById('step3').style.color = '#999';
      
      document.getElementById('unpay-confirm-message').textContent = 'Ø¢ÛŒØ§ Ø§Ø² Ø¨Ø±Ú¯Ø´Øª Ø§ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ';
      document.getElementById('unpay-confirm-btn').textContent = 'ØªØ§ÛŒÛŒØ¯ Ù…Ø±Ø­Ù„Ù‡ 1';
      
      document.getElementById('unpay-confirm-modal').classList.add('active');
    }
    
    function handleUnpayConfirmation() {
      unpayConfirmStep++;
      
      if (unpayConfirmStep === 1) {
        document.getElementById('step1').style.color = '#f39c12';
        document.getElementById('unpay-confirm-message').textContent = 'Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª. Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ';
        document.getElementById('unpay-confirm-btn').textContent = 'ØªØ§ÛŒÛŒØ¯ Ù…Ø±Ø­Ù„Ù‡ 2';
      } else if (unpayConfirmStep === 2) {
        document.getElementById('step2').style.color = '#f39c12';
        document.getElementById('unpay-confirm-message').textContent = 'ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ: Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!';
        document.getElementById('unpay-confirm-btn').textContent = 'ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ';
      } else if (unpayConfirmStep === 3) {
        document.getElementById('step3').style.color = '#f39c12';
        executeUnpayment();
      }
    }
    
    function executeUnpayment() {
      if (!currentLoan || unpayInstallmentIndex === null) return;
      
      try {
        let installments = [];
        try {
          installments = JSON.parse(currentLoan.installments || '[]');
        } catch (e) {
          installments = [];
        }
        
        if (unpayInstallmentIndex >= installments.length) return;
        
        // Reset payment status
        installments[unpayInstallmentIndex].paid = "0";
        delete installments[unpayInstallmentIndex].payerName;
        delete installments[unpayInstallmentIndex].paidAmount;
        delete installments[unpayInstallmentIndex].paidDate;
        delete installments[unpayInstallmentIndex].paymentSource;
        delete installments[unpayInstallmentIndex].notes;
        
        const updatedLoan = {
          ...currentLoan,
          installments: JSON.stringify(installments)
        };
        
        // Update in allLoans array
        const index = allLoans.findIndex(l => l.__backendId === currentLoan.__backendId);
        if (index !== -1) {
          allLoans[index] = updatedLoan;
          saveDataToStorage();
          renderLoans();
          updateStats();
          
          showToast('Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯', 'warning');
          closeUnpayConfirmModal();
          openPaymentsModal(currentLoan.__backendId);
        }
      } catch (error) {
        console.error('Error executing unpayment:', error);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ú¯Ø´Øª Ù¾Ø±Ø¯Ø§Ø®Øª', 'error');
      }
    }
    
    function closeUnpayConfirmModal() {
      document.getElementById('unpay-confirm-modal').classList.remove('active');
      unpayConfirmStep = 0;
      unpayInstallmentIndex = null;
    }
    
    // Export functions
    function exportLoan(loanId, format) {
      const loan = allLoans.find(l => l.__backendId === loanId);
      if (!loan) return;
      
      let installments = [];
      try {
        installments = JSON.parse(loan.installments || '[]');
      } catch (e) {
        installments = [];
      }
      
      if (format === 'excel') {
        exportToExcel(loan, installments);
      } else if (format === 'html') {
        exportToHTML(loan, installments);
      }
    }
    
    function exportToExcel(loan, installments) {
      let csv = '\uFEFF';
      csv += 'Ù†Ø§Ù… ÙˆØ§Ù…,Ø¨Ø§Ù†Ú©,ØµØ§Ø­Ø¨ ÙˆØ§Ù…,Ù…Ø¨Ù„Øº ÙˆØ§Ù…,Ù†Ø±Ø® Ø³ÙˆØ¯,ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·,ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹,ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†\n';
      csv += `${loan.loan_name},${loan.bank_name},${loan.owner_name},${loan.loan_amount},${loan.interest_rate}%,${installments.length},${toJalali(loan.start_date)},${toJalali(loan.end_date)}\n\n`;
      
      csv += 'Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø³Ø·,Ù…Ø¨Ù„Øº,Ø³Ø±Ø±Ø³ÛŒØ¯,ÙˆØ¶Ø¹ÛŒØª,ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª,Ù…Ù†Ø¨Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª,ØªÙˆØ¶ÛŒØ­Ø§Øª\n';
      installments.forEach(inst => {
        csv += `${inst.number},${inst.amount},${toJalali(inst.dueDate)},${inst.paid === "1" ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡' : 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯Ù‡'},${inst.paidDate ? toJalali(inst.paidDate) : '-'},${inst.paymentSource || '-'},${inst.notes || '-'}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${loan.loan_name}_${new Date().getTime()}.csv`;
      link.click();
      
      showToast('ÙØ§ÛŒÙ„ Excel Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
    }
    
    function exportToHTML(loan, installments) {
      const html = `
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
          <meta charset="UTF-8">
          <title>Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ù… - ${loan.loan_name}</title>
          <style>
            body { font-family: Tahoma, sans-serif; padding: 20px; }
            h1 { color: #667eea; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }
            th { background: #667eea; color: white; }
            .info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
            .paid { background: #e8f5e9; }
          </style>
        </head>
        <body>
          <h1>Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ù…: ${loan.loan_name}</h1>
          <div class="info">
            <p><strong>Ø¨Ø§Ù†Ú©:</strong> ${loan.bank_name}</p>
            <p><strong>ØµØ§Ø­Ø¨ ÙˆØ§Ù…:</strong> ${loan.owner_name}</p>
            <p><strong>Ù…Ø¨Ù„Øº ÙˆØ§Ù…:</strong> ${formatCurrency(parseFloat(loan.loan_amount || '0'))}</p>
            <p><strong>Ù†Ø±Ø® Ø³ÙˆØ¯:</strong> ${loan.interest_rate}%</p>
            <p><strong>ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·:</strong> ${installments.length}</p>
            <p><strong>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹:</strong> ${toJalali(loan.start_date)}</p>
            <p><strong>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†:</strong> ${toJalali(loan.end_date)}</p>
            ${loan.description ? `<p><strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${loan.description}</p>` : ''}
          </div>
          
          <h2>Ø§Ù‚Ø³Ø§Ø·</h2>
          <table>
            <thead>
              <tr>
                <th>Ø´Ù…Ø§Ø±Ù‡</th>
                <th>Ù…Ø¨Ù„Øº</th>
                <th>Ø³Ø±Ø±Ø³ÛŒØ¯</th>
                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                <th>ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª</th>
                <th>Ù…Ù†Ø¨Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª</th>
                <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              ${installments.map(inst => `
                <tr class="${inst.paid === "1" ? 'paid' : ''}">
                  <td>${inst.number}</td>
                  <td>${formatCurrency(parseFloat(inst.amount || '0'))}</td>
                  <td>${toJalali(inst.dueDate)}</td>
                  <td>${inst.paid === "1" ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡' : 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯Ù‡'}</td>
                  <td>${inst.paidDate ? toJalali(inst.paidDate) : '-'}</td>
                  <td>${inst.paymentSource || '-'}</td>
                  <td>${inst.notes || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
        </html>
      `;
      
      const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${loan.loan_name}_${new Date().getTime()}.html`;
      link.click();
      
      showToast('ÙØ§ÛŒÙ„ HTML Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'success');
    }
    
    // Tab functions
    function switchTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      if (tab === 'active') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('active-tab').classList.add('active');
      } else {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('archived-tab').classList.add('active');
      }
    }
    
    // Utility functions
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // Event listeners
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.calendar') && !e.target.closest('input[readonly]')) {
        document.querySelectorAll('[id$="-calendar"]').forEach(cal => {
          cal.style.display = 'none';
        });
      }
    });
    
    // Initialize app - show login screen first
    document.addEventListener('DOMContentLoaded', () => {
      // Show login screen by default
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
      
      // Update sync status every minute
      setInterval(updateSyncStatus, 60000);
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99932ed6d0ca9f15',t:'MTc2MjI0OTU3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
